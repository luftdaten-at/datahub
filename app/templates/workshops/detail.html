{% extends "_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ workshop.title }}{% endblock title %}

{% block styles %}
<!-- Leaflet CSS -->
<!--<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-rotate-map@0.3.1/leaflet.min.css">

<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}" crossorigin="">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}" crossorigin="">

<!-- Leaflet JS -->
<!--<script src="{% static 'js/leaflet.js' %}" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>-->
<script src="https://cdn.jsdelivr.net/npm/leaflet-rotate-map@0.3.1/leaflet-src.min.js"></script>

<script src="{% static 'js/TileLayer.Grayscale.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
<!--<script src="{% static 'js/leaflet.markercluster.js' %}"></script>-->


<style>
    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }
    .info i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    .legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 0 10px;
    }
    
    .legend-item i {
        width: 18px;
        height: 18px;
        margin-right: 5px;
    }
    .leaflet-center {
        left: 50%;
        transform: translate(-50%, 0%);
    }    
</style>
{% endblock styles %}

{% block map %}
<div class=".container-fluid">
    <div class="position-absolute top-0 end-0 card"
        style="width: 18rem; z-index: 1000; margin-top: 4.5rem; margin-right: 1rem;">
        <div class="card-body">
            <h5 class="card-title">{% trans "Measurement Type" %}</h5>
            <select class="form-select" id="select-value" aria-label="Default select example" onchange="updateValues()">
                <option value="pm1">{% trans "Particulate Matter PM1.0" %}</option>
                <option value="pm25" selected>{% trans "Particulate Matter PM2.5" %}</option>
                <option value="pm10">{% trans "Particulate Matter PM10.0" %}</option>
                <option value="temperature">{% trans "Temperature" %}</option>
            </select>
            <h5 class="card-title" style="margin-top: 1rem;">{% trans "Device" %}</h5>
            <select class="form-select" id="select-device" aria-label="Default select example" onchange="updateValues()">
                <option value="all" selected>{% trans "All devices" %}</option>
            </select>
        </div>
    </div>
    <div id="map">
    </div>
</div>
{% endblock map %}

{% block content %}
    <div class="mt-3 mb-5">
        <h2>{{ workshop.title }}</h2>
        <p>{{ workshop.description }}</p>
        <p>Von {{ workshop.start_date }} bis {{ workshop.end_date }}</p>
        <p>Code: {{ workshop.name }}</p>

        <h4>{% trans "Devices" %}</h4>
            <ul id="device-list"></ul>    

        <h4>{% trans "Download" %}</h4>
        <a href="{% url 'workshop_export_csv' workshop.pk %}" class="btn btn-primary btn-sm">
            <i class="bi bi-download me-1"></i>
            {% trans "CSV" %}
        </a>
    </div>
    <script>
        const colorSteps = [
            [0, [115, 0.8, 0.8]],
            [5, [115, 0.8, 0.8]],
            [15, [60, 0.87, 0.95]],
            [25, [0, 0.87, 0.8]],
            [60, [0, 0.87, 0.4]],
        ];
    
        function interpolate(a, b, fraction) {
            return [a[0] + (b[0] - a[0]) * fraction, a[1] + (b[1] - a[1]) * fraction, a[2] + (b[2] - a[2]) * fraction];
        }
    
        function getColorForPM25(value) {
            if(isNaN(value) || value == null) return [0, 0, 0.7]; // grey
            for (let i = 0; i < colorSteps.length - 1; i++) {
                if (value >= colorSteps[i][0] && value < colorSteps[i + 1][0]) {
                    const fraction = (value - colorSteps[i][0]) / (colorSteps[i + 1][0] - colorSteps[i][0]);
                    return interpolate(colorSteps[i][1], colorSteps[i + 1][1], fraction);
                }
            }
            return colorSteps[colorSteps.length - 1][1];
        }
    
        let hsv2hsl = (h, s, v, l = v - v * s / 2, m = Math.min(l, 1 - l)) => [h, m ? (v - l) / m : 0, l];
    
        function updateValues() {
            var value = document.getElementById("select-value").value;
            var device = document.getElementById("select-device").value;
            if(device == "all") device = null;
            addMarkerLayer(value, device);

            // Update legend
            var legend = document.getElementById("legend");
            legend.innerHTML = "";
            colorRanges[value].forEach(function (range) {
                legend.innerHTML +=
                    '<div class="legend-item">' +
                    '<i style="background:' + range.color + '"></i> ' +
                    range.label +
                    '</div>';
            });
        }
    
        const map = L.map('map', {fadeAnimation: false, rotate: true }).setView([48.2112, 16.3736], 13);
    
        const tiles = L.tileLayer.grayscale('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '<a href="https://luftdaten.at">CC BY 2024 Luftdaten.at</a> | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
    
        var points;
    
        async function fetchMarkerData() {
            const fetch_url = "/api/v1/workshops/{{ workshop.name }}/data/";
            console.log(fetch_url);
            const response = await fetch(fetch_url);
    
            points = [];
    
            // Parse response JSON
            const text = await response.text();
            const json = JSON.parse(text);
            for (let item in json) {
                points.push(json[item]);
            }
        }
    
        function showDeviceList() {
            // 1. Erzeuge ein Objekt deviceCounts = { deviceName: Anzahl, ... }
            const deviceCounts = {};
            for (let i = 0; i < points.length; i++) {
                const device = points[i].device;
                if (!deviceCounts[device]) {
                    deviceCounts[device] = 0;
                }
                deviceCounts[device]++;
            }
    
            // 2. FÃ¼ge die Daten in <ul id="device-list"> ein
            const ul = document.getElementById("device-list");
            ul.innerHTML = "";  // ggf. leeren, falls schon was drinsteht
            for (const device in deviceCounts) {
                const li = document.createElement("li");
                li.textContent = `${device}: ${deviceCounts[device]} {% trans "measurements" %}`;
                ul.appendChild(li);
            }
        }

        fetchMarkerData().then(() => {
            addMarkerLayer("pm25");
            const devices = new Set();
            for(let i = 0; i < points.length; i++) {
                devices.add(points[i].device);
            }
            const select = document.getElementById("select-device");
            for (let device of devices) {
                var option = document.createElement("option");
                option.text = device;
                option.value = device;
                select.add(option);
            }
            showDeviceList();
        });
    
        function getMean(arr) {
            var acc = 0;
            var count = 0;
            for(let i = 0; i < arr.length; i++) {
                if(isNaN(arr[i])) continue;
                acc += Number(arr[i]);
                count++;
            }
            if(count == 0) return NaN;
            return acc / count;
        }
    
        var markerLayer;
    
        async function addMarkerLayer(value, device = null) {

            // Log that this function was called
            console.log("addMarkerLayer called with value: " + value + " and device: " + device);
    
            if (markerLayer != null) {
                map.removeLayer(markerLayer);
            }
    
            // Marker layer
            markerLayer = L.layerGroup({
                iconCreateFunction: function (cluster) {
                    const meanPM = getMean(cluster.getAllChildMarkers().map(marker => marker.pm));
                    const colorArrayHSV = getColorForPM25(meanPM); // TODO use different boundaries for different PM
                    const colorArrayHSL = hsv2hsl(colorArrayHSV[0], colorArrayHSV[1], colorArrayHSV[2]);
                    const colorString = `hsl(${colorArrayHSL[0]}, ${colorArrayHSL[1] * 100}%, ${colorArrayHSL[2] * 100}%)`;
                    const textColor = colorArrayHSL[2] > 0.45 ? "black" : "white";
                    return L.divIcon({iconSize: [6, 6], className: '', html: '<div class="clickable" style="height: 0.5em; width: 0.5em; background-color: ' + colorString + '; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10pt; border-style: solid; border-color: white;"></div>'});
                },
                showCoverageOnHover: false,
            });
    
            const markerList = [];
    
            // Add markers for each point
            for (let i in points) {
                const point = points[i];
                if(device != null && point.device != device) continue;
                const pm = point[value];
                const colorArrayHSV = getColorForPM25(pm);
                const colorArrayHSL = hsv2hsl(colorArrayHSV[0], colorArrayHSV[1], colorArrayHSV[2]);
                var colorString = `hsl(${colorArrayHSL[0]}, ${colorArrayHSL[1] * 100}%, ${colorArrayHSL[2] * 100}%)`;
                const textColor = colorArrayHSL[2] > 0.45 ? "black" : "white";

                // Temp: just set colorString to be the hex color defined in the colorRanges
                colorString = colorRanges[value].find(range => pm >= range.range[0] && pm < range.range[1]).color;

                var marker = L.marker([point.lat, point.lon], {icon: L.divIcon({iconSize: [6, 6], className: '', html: '<a class="hiddenlink clickable"><div style="height: 0.5em; width: 0.5em; background-color: ' + colorString + '; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10pt;"></div></a>'})});
                marker.pm = pm; // Add a custom attribute to marker
                var unit;
                if(value == "pm1") unit = " Âµg/mÂ³";
                else if(value == "pm25") unit = " Âµg/mÂ³";
                else if(value == "pm10") unit = " Âµg/mÂ³";
                else if(value == "temperature") unit = "Â°C";
                marker.bindPopup(pm + unit); // Bind a popup to the marker
                markerList.push(marker);
            }
    
            for (let i = 0; i < markerList.length; i++) {
                markerLayer.addLayer(markerList[i]);
            }
            
            map.addLayer(markerLayer);
        };
    
        function requestStationData(uid) {
            loadDataForStation(uid);
            return true;
        }
    
        const colorRanges = {
        'pm1': [
            { label: '{% trans "Gut (<5 Âµg/mÂ³)" %}', color: '#36cc29', range: [0, 5] },
            { label: '{% trans "Befriedigend (5-15 Âµg/mÂ³)" %}', color: '#f2f21f', range: [5, 15] },
            { label: '{% trans "Schlecht (15-25 Âµg/mÂ³)" %}', color: '#cc1b1b', range: [15, 25] },
            { label: '{% trans "Sehr schlecht (>25 Âµg/mÂ³)" %}', color: '#660d0d', range: [25, 100000] },
        ],
        'pm25': [
            { label: '{% trans "Gut (<5 Âµg/mÂ³)" %}', color: '#36cc29', range: [0, 5] },
            { label: '{% trans "Befriedigend (5-15 Âµg/mÂ³)" %}', color: '#f2f21f', range: [5, 15] },
            { label: '{% trans "Schlecht (15-25 Âµg/mÂ³)" %}', color: '#cc1b1b', range: [15, 25] },
            { label: '{% trans "Sehr schlecht (>25 Âµg/mÂ³)" %}', color: '#660d0d', range: [25, 100000] },
        ],
        'pm10': [
            { label: '{% trans "Gut (<15 Âµg/mÂ³)" %}', color: '#36cc29', range: [0, 15] },
            { label: '{% trans "Befriedigend (15-45 Âµg/mÂ³)" %}', color: '#f2f21f', range: [15, 45] },
            { label: '{% trans "Schlecht (45-60 Âµg/mÂ³)" %}', color: '#cc1b1b', range: [45, 60] },
            { label: '{% trans "Sehr schlecht (>60 Âµg/mÂ³)" %}', color: '#660d0d', range: [60, 100000] },
        ],
        'temperature': [
            { label: '{% trans "Kalt (<0Â°C)" %}', color: '#0000ff', range: [-100, 0] },
            { label: '{% trans "KÃ¼hl (0-10Â°C)" %}', color: '#00ffff', range: [0, 10] },
            { label: '{% trans "Mild (10-20Â°C)" %}', color: '#00ff00', range: [10, 20] },
            { label: '{% trans "Warm (20-30Â°C)" %}', color: '#ffff00', range: [20, 30] },
            { label: '{% trans "HeiÃ (>30Â°C)" %}', color: '#ff0000', range: [30, 400] },
        ]};
    
        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend leaflet-center');
            div.id = 'legend';
            colorRanges['pm25'].forEach(function (range) {
                div.innerHTML +=
                    '<div class="legend-item">' +
                    '<i style="background:' + range.color + '"></i> ' +
                    range.label +
                    '</div>';
            });
            return div;
        };
        
        legend.addTo(map);

        // Add a class to the outermost div
        legend._container.className += ' leaflet-center';

    // Button "Zoom to all"
    var fitBoundsControl = L.control({ position: 'bottomleft' });

    fitBoundsControl.onAdd = function(map) {
        var controlDiv = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        controlDiv.innerHTML = `
            <button
                class="btn btn-secondary btn-sm"
                id="fitBoundsButton"
                style="display: flex; align-items: center; justify-content: center; gap: 4px;"
                title={% trans "Zoom map to show all points." %}
            >
                <i class="bi bi-arrows-fullscreen"></i>
                {% trans "Zoom to all" %}
            </button>
        `;
        return controlDiv;
    };

    fitBoundsControl.addTo(map);

    document.addEventListener("click", function(e) {
        if (e.target.closest("#fitBoundsButton")) {
            fitMapToAllPoints();
        }
    });

    function fitMapToAllPoints() {
        if (!points || points.length === 0) {
            return;
        }
        
        const latLngs = points.map(item => [item.lat, item.lon]);
        const bounds = L.latLngBounds(latLngs);
        map.fitBounds(bounds);
    }
    </script>

{% endblock content %}