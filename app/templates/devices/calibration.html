{% extends "_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Calibration View" %}{% endblock title %}
{% block styles %}
{% if host == "arbeitsplatz.luftdaten.at" or host == "staging.arbeitsplatz.luftdaten.at" %}
{% else %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="{% static 'css/leaflet.css' %}" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.css' %}" crossorigin="">
<link rel="stylesheet" href="{% static 'css/MarkerCluster.Default.css' %}" crossorigin="">

<!-- Leaflet JS -->
<script src="{% static 'js/leaflet.js' %}" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="{% static 'js/TileLayer.Grayscale.js' %}"></script>
<script src="{% static 'js/leaflet.markercluster.js' %}"></script>

<script src="{% static 'js/chart.umd.js' %}" crossorigin=""></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>

{% endif %}
{% endblock styles %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
   
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


<h2>{% trans "Select Devices for Calibration" %}</h2>

<form id="device-form">
  <ul id="device-list" style="max-height: 200px; overflow-y: auto;"></ul>
  <button type="submit">{% trans "Submit" %}</button>

  <canvas id="deviceChart" width="800" height="400" style="margin-top:20px;"></canvas>
</form>

<script>

const listEl = document.getElementById('device-list');
const formEl = document.getElementById('device-form');
const ctx = document.getElementById('deviceChart').getContext('2d');
let allData = {};
let chart = null;
const dimension = "7"; // Fixed dimension filter

document.addEventListener('DOMContentLoaded', () => {
  // Fetch devices and populate the list
  fetch('https://staging.api.luftdaten.at/v1/station/calibration?data=false')
    .then(r => r.text())
    .then(text => {
      const devices = text.split('\n').filter(d => d.trim() !== '');
      devices.forEach((device, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <label>
            <input type="checkbox" name="selected_devices" value="${device}" ${i === 0 ? 'checked' : ''}>
            ${device}
          </label>
        `;
        listEl.appendChild(li);
      });
    })
    .then(fetchCalibrationData)  // After devices are loaded, fetch data

  // Fetch calibration CSV data once and parse
  function fetchCalibrationData() {
    fetch('https://staging.api.luftdaten.at/v1/station/calibration?data=true')
      .then(r => r.text())
      .then(csv => {
        allData = {};
        csv.trim().split('\n').forEach(line => {
          const [name, model, dim, val, time] = line.split(',').map(s => s.trim());
          if (!allData[name]) allData[name] = {};
          if (!allData[name][dim]) allData[name][dim] = {};
          if (!allData[name][dim][model]) allData[name][dim][model] = [];
          allData[name][dim][model].push({ x: time, y: parseFloat(val) });
        });
        updateChart();
      });
  }

  // Get selected devices from checkboxes
  function getSelectedDevices() {
    return [...document.querySelectorAll('input[name="selected_devices"]:checked')].map(cb => cb.value);
  }

  // Build datasets for Chart.js from selected devices
  function buildDatasets(selectedDevices) {
    const datasets = [];
    selectedDevices.forEach(name => {
      const models = allData[name]?.[dimension];
      if (!models) return;
      for (const model in models) {
        datasets.push({
          label: `${name} (${model})`,
          data: models[model],
          borderColor: randomColor(),
          fill: false,
          tension: 0.1,
          pointRadius: 0,
        });
      }
    });
    return datasets;
  }

  // Create or update the chart
  function updateChart() {
    const selected = getSelectedDevices();
    const datasets = buildDatasets(selected);
    console.log(datasets);
    if (chart) {
      chart.data.datasets = datasets;
      chart.update();
    } else {
      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          parsing: true,
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'minute' },
              title: { display: true, text: 'Time' }
            },
            y: { title: { display: true, text: 'Value' } }
          },
          plugins: {
            legend: { display: true, position: 'bottom' }
          }
        }
      });
    }
  }

  // Random pastel-ish color generator
  function randomColor() {
    return `hsl(${Math.random() * 360}, 70%, 60%)`;
  }

  // Update chart when device selection changes
  formEl.addEventListener('change', (e) => {
    if (e.target.name === 'selected_devices') {
      console.log('update chart');
      updateChart();
    }
  });

  // Prevent form submission (optional)
  formEl.addEventListener('submit', e => {
    e.preventDefault();
    // You can handle form submit here if needed
  });
});
</script>
{% endblock content %}